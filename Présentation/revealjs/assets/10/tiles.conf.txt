# ---------------------------
# üó∫Ô∏è Configuration compl√®te avec cache et headers OSM
# ---------------------------

# User-Agent obligatoire avec contact
map $http_user_agent $osm_ua {
    "" "GCTracker/1.0 (+jean.ceugniet@gmail.com)";
    default "$http_user_agent GCTracker/1.0 (+jean.ceugniet@gmail.com)";
}

# ---- choose upstream host deterministically (a/b/c) ----
split_clients "${remote_addr}${request_uri}" $osm_server {
    33.3% "a.tile.openstreetmap.org";
    33.3% "b.tile.openstreetmap.org";
    *     "c.tile.openstreetmap.org";
}

# Bypass du cache si le client envoie "no-cache" ou "max-age=0"
map $http_cache_control $client_no_cache {
    default        0;
    ~*no-cache     1;
    ~*max-age=0    1;
}

# Rate limiting CLIENT ‚Üí NOTRE SERVEUR (permissif pour UX)
limit_req_zone $binary_remote_addr zone=client_tiles:10m rate=20r/s;

# Rate limiting NOTRE SERVEUR ‚Üí OSM (STRICT selon recommandations OSM)  
limit_req_zone $upstream_addr zone=osm_upstream:10m rate=2r/s;

# DNS resolver pour la r√©solution dynamique des noms OSM
resolver 127.0.0.11 valid=300s ipv6=off;
resolver_timeout 5s;

# Cache disque
proxy_cache_path /var/cache/nginx/tiles_cache
    levels=1:2
    keys_zone=tiles_cache:200m
    max_size=50g
    inactive=30d
    use_temp_path=off;
        
server {
    listen 80;
    server_name _;

    # Logs d√©taill√©s
    access_log /dev/stdout;
    error_log  /dev/stderr warn;

    #access_log /var/log/nginx/tiles_access.log combined;
    #error_log /var/log/nginx/tiles_error.log warn;

    # Sant√© rapide : http://host:8080/tiles/_health.png
    location = /tiles/_health.png {
        root /var/www;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    location /tiles/ {
        # Limite c√¥t√© client (permet navigation fluide)
        limit_req zone=client_tiles burst=50 nodelay;
        
        # Limite vers OSM (STRICTE - respecte leurs guidelines)
        limit_req zone=osm_upstream burst=5 nodelay;

        # Validation format tiles
        if ($uri !~ "^/tiles/[0-9]{1,2}/[0-9]+/[0-9]+\.png$") {
            return 404;
        }

        # Validation zoom level (0-19 pour OSM)
        if ($uri ~ "^/tiles/([2-9][0-9]|[0-9]{3})/") {
            return 404;
        }

        # retirer le pr√©fixe /tiles/
        rewrite ^/tiles/(.*)$ /$1 break;

        # PROXY VERS OSM
        proxy_pass https://$osm_server;

        # TLS/SNI
        proxy_ssl_server_name on;
        proxy_ssl_name $osm_server;
        proxy_ssl_protocols TLSv1.2 TLSv1.3;
        proxy_ssl_verify off;

        # Headers OSM requis
        proxy_set_header Host tile.openstreetmap.org;
        proxy_set_header User-Agent $osm_ua;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Utilise HTTP/1.1 c√¥t√© upstream + pas de Connection: keep-alive explicite
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # Neutralise la compression (√©vite variations CDN)
        proxy_set_header Accept-Encoding "";
        proxy_set_header Cache-Control "";
        proxy_set_header Pragma "";

        add_header X-Upstream-Host $osm_server always;  # debug

        # --- CACHE ---
        proxy_cache tiles_cache;
        proxy_cache_key $scheme$proxy_host$request_uri;
        proxy_cache_bypass $client_no_cache;

        # Respect de la fra√Æcheur amont
        proxy_cache_revalidate on;      # envoie If-None-Match/If-Modified-Since
        proxy_pass_header Cache-Control;
        proxy_pass_header Expires;
        proxy_pass_header ETag;
        proxy_pass_header Last-Modified;

        # Dur√©es de cache selon OSM
        proxy_cache_valid 200 304 7d;    # tiles valides: 7 jours
        proxy_cache_valid 404 1m;        # tiles manquantes: 1 minute
        proxy_cache_valid 403 1h;        # rate limit upstream: 1 heure
        proxy_cache_valid 500 502 503 504 30s; # erreurs serveur: 30s

        # Eviter les avalanches
        proxy_cache_lock on;
        proxy_cache_lock_timeout 5s;
        proxy_cache_lock_age 300s;

        # Servir du stale si souci amont
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_background_update on;

        # Timeouts adapt√©s
        proxy_connect_timeout 10s;
        proxy_send_timeout 15s;
        proxy_read_timeout 30s;
        proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
        proxy_next_upstream_tries 3;

        # Headers debug
        add_header X-Cache-Status $upstream_cache_status always;
        add_header X-Selected-Server $osm_server always;
        add_header X-Cache-Key "$scheme$proxy_host$request_uri" always;

        # Cache c√¥t√© client (respecte les recommandations OSM)
        add_header Cache-Control "public, max-age=604800" always; # 7 jours
        add_header Vary "Accept-Encoding" always;

        # S√©curit√©
        add_header X-Content-Type-Options "nosniff" always;

        # pas de cookies
        proxy_ignore_headers Set-Cookie;
        proxy_hide_header Set-Cookie;
    }

    # Bloquer toutes les autres requ√™tes
    location / {
        return 404;
    }

}
